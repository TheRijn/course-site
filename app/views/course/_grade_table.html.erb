<table id="grade-table" class="table table-condensed">

	<tr>
		<th>Name</th>
		<th>ID</th>
		<% if schedules.any? %>
		<th>Schedule</th>
		<th>Progress</th>
		<% end %>
		<% psets.each do |pset| %>
		<th><%= pset.name %></th>
		<% end %>
		<th>
			<form method="get" accept-charset="utf-8">
				<%= select_tag :term, 
						options_from_collection_for_select(Registration.select("distinct term"), :term, :term, selected:params[:term]),
						include_blank: true,
						onchange: 'this.form.submit();' %>
				<%= hidden_field_tag "status", params[:status] %>
			</form>
		</th>
		<th>
			<form method="get" accept-charset="utf-8">
				<%= hidden_field_tag "term", params[:term] %>
				<%= select_tag :status, 
						options_from_collection_for_select(Registration.select("distinct status"), :status, :status, selected:params[:status]),
						include_blank: true,
						onchange: 'this.form.submit();' %>
			</form>
		</th>
	</tr>

	<% users.each do |user| %>
	<% subs = user.submits.group_by(&:pset_id); submitted = false %>
	<tr>
		<td>
			<%= best_in_place user, :name, type: :input, path: course_change_user_name_path(id: user.id) %>
		</td>
		<td>
			<% if user.mail %>
			<%= link_to user.uvanetid, 'mailto:' + user.mail %>
			<% else %>
			<%= user.uvanetid %>
			<% end %>
		</td>
		<% if schedules.any? %>
		<td>
			<% if r = user.registrations.first %>
			<%= best_in_place r, :schedule_id, type: :select, path: registration_path(id: r.id), collection: schedules.select("distinct name, id").map { |i| [i.id, i.name] } + ['', ''] %>
			<% end %>
		</td>
		<td>
			<% if r = user.registrations.first %>
			<%= x = r.schedule_span and x.name %>
			<% end %>
		</td>
		<% end %>
		<% psets.each do |pset| %>
		<td>
			<% if subs[pset.id] %>
				<% submitted = subs[pset.id][0] %>
				<% if submitted.grade and not submitted.grade.grade.blank? %>
				<%= link_to "#{submitted.grade.grade}", grade_form_path(user_id: user.id, pset_id: pset.id), class: "btn btn-xs btn-block #{0 <= submitted.grade.grade && submitted.grade.grade < 5.5 ? 'btn-danger':'btn-success'}" %>
				<% else %>
				<%= link_to 'sub', grade_form_path(user_id: user.id, pset_id: pset.id), class: 'btn btn-default btn-xs btn-block' %>
				<% end %>
			<% else %>
				<%= link_to 'no', grade_form_path(user_id: user.id, pset_id: pset.id), class:'btn btn-default btn-xs btn-block auto-hide', data: { confirm:'Would you like to enter a grade for this unsubmitted pset?' } %>
			<% end %>
		</td>
		<% end %>
		<% if r = user.registrations.first %>
		<td><%= best_in_place r, :term, type: :input, path: registration_path(id: r.id) %></td>
		<td><%= best_in_place r, :status, type: :input, path: registration_path(id: r.id) %></td>
		<% end %>
		<td>
		<%= link_to_if !submitted, '<span class="glyphicon glyphicon-trash"></span>'.html_safe, course_remove_student_path(student_id: user.uvanetid), method: :post, data: { confirm: "Sikker?" } do "" end %>
		</td>
		
	</tr>
	<% end %>

</table>
