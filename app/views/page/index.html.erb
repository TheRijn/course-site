<div class="container-fluid">
	<div class="row-fluid">
		<div class="span8 offset2">

			<section id="content" style="padding:1em;">

				<div class="tabbable">
					
					<ul id="links" class="nav nav-tabs">
						<% @page.subpages.each_with_index do |subpage, index| %>
						<li class="<%= 'active' if index == 0 %>">
							<a href="#<%= subpage.slug %>" data-toggle="tab"><%= subpage.title %></a>
						</li>
						<% end %>
						<% if logged_in? && @page.needs_submit? %>
						<li><a href="#submit" data-toggle="tab">Submit</a></li>
						<% end %>
					</ul>

					<%= form_tag({ :controller => 'upload', :action => 'submit' }, { :multipart => true, :id => "page_form" }) do %>
					<%= hidden_field_tag :page_id, @page.id %>
					<div class="tab-content">
						<% @page.subpages.each_with_index do |subpage, index| %>
						<div class="tab-pane markdown <%= 'active' if index == 0 %>" id="<%= subpage.slug %>">
							<%= markdown(subpage.content, @page) %>
						</div>
						<% end %>
						<% if logged_in? && @page.needs_submit? %>
						<div class="tab-pane markdown" id="submit">
							<h1>Submit</h1>
							<table class="table">
								<tr>
									<th>filename</th>
									<th></th>
									<th></th>
								</tr>
								<% if @page.form %>
								<tr>
									<td>form.txt</td>
									<td>Automatically generated from your answers on this page.</td>
									<td></td>
								</tr>
								<% end %>
								<% @page.page_submissions.each do |s| %>
								<tr>
									<td><%= s.filename %></td>
									<td><%= file_field_tag "f[#{s.filename}]", :accept => File.extname(s.filename), :required => s.required %></td>
									<td><%= 'required' if s.required %></td>
								</tr>
								<% end %>
							</table>
							<p>Notes: <%= text_area_tag 'notes' %></p>
							<p><%= submit_tag 'Submit for grading', :class => 'btn btn-warning' %></p>
						</div>
						<% end %>
					</div>
					<% end %>
					
					<% if logged_in? %>
					<script>
						var form_cache = <%= @answer_data.to_json.html_safe %>;
						if(form_cache)
						{
							$.each($("input[type=text], textarea"),
								function(i,v)
								{
									if(form_cache[v.name])
									{
										v.value = form_cache[v.name];
									}
								}
							);
						}
						$("input[type=text],textarea").change(function()
						{
							$("#loading").show();
							// $("#page_form").submit();
							$.post("/answers.json", $("#page_form").serialize());
							window.setTimeout(function(){$("#loading").hide()}, 1000);
						})
					</script>
					<% end %>

				</div>

			</section>

		</div>
	</div>
</div>
